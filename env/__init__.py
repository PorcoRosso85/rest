from env import gcloud

env_design = [
    {
        "アプリ": [
            # {"python3アプリの新規コンテナ": []},
            {
                "環境変数の代わりにGoogle Cloud KMSを使用する": [
                    gcloud.Testアプリ.test200_cloudsqlの接続情報が暗号化できている
                ]
            },
            gcloud.Testアプリ.test200_DjangoでGoogleCloudPythonConnectorを設定できている,
            gcloud.Testアプリ.test200_DjangoでCloudSQLに接続できている,
            {
                "Djangoの設定とその最適化をする": [
                    {
                        "設定する": [
                            "ALLOWED_HOSTS",
                            "DEBUG",
                            "SECRET_KEY",
                            "DATABASES",
                            "STATIC_ROOT",
                            "STATIC_URL",
                            "MEDIA_ROOT",
                            "MEDIA_URL",
                        ]
                    },
                    "DB接続の最適化をする",
                    "静的ファイルの最適化をする",
                ]
            },
        ]
    },
    {
        "ビルド": [
            {
                gcloud.Testビルド.test200_Dockerfileを作成する: [
                    "ベースイメージを選択する",
                    "必要なライブラリをインストールする",
                    "アプリケーションコードをコピーする",
                    "コマンドを実行する",
                    {
                        "ビルドオプションを設定する": [
                            "キャッシュの利用",
                            "ビルド時の環境変数",
                            "ビルド後のイメージのサイズ",
                        ]
                    },
                    {
                        "Dockerfileの最適化する": [
                            "イメージのサイズを最適化する",
                            "セキュリティを最適化する",
                            "ビルド時間を最適化する",
                            "マルチステージビルドをする",
                        ]
                    },
                ]
            },
            {
                gcloud.Testビルド.tsst200_GoogleCloudBuildでビルドする: [
                    "ビルド構成ファイルをローカルで作成する",
                    "ビルドを実行する",
                    "ビルド結果を確認する",
                ]
            },
        ]
    },
    {
        "デプロイ": [
            {
                "VPCを設定する": [
                    "VPCの作成",
                    "サブネットの作成",
                    "ファイアウォールの設定",
                ]
            },
            {
                "ネットワーク設定をする": [
                    "サービスの公開範囲",
                    "IPアドレスの許可範囲",
                    "ロードバランサーの設定",
                ]
            },
            {
                "認証と認可をする": [
                    {
                        "IAMの設定": [
                            "エンティティの作成",
                            "ロールの設定",
                            "ポリシーの設定",
                            "サービスアカウントのキー付与",
                        ],
                    },
                    {
                        "APIキーの設定": [
                            "APIキーの作成",
                            "APIキーの設定",
                        ],
                    },
                    {
                        "OAuth2.0の設定: 安全にサービスアカウントキーを認証するプロトコルを使用するかのオプション": []
                    },
                    {
                        "RBACの設定: Cloud RunにCloud SQLへのアクセス権を付与する": [
                            "Cloud RunのサービスアカウントにCloud SQLのクライアント権限を付与する"
                        ]
                    },
                ]
            },
            {
                "ログ設定をする": [
                    {"出力先を設定する": ["Cloud Logging", "stdout"]},
                    "ログレベル",
                ]
            },
            {
                "モニタリングをする": [
                    {
                        "メトリクスを設定する": [
                            "CPU",
                            "メモリ",
                            "ネットワーク",
                            "",
                        ]
                    },
                    {
                        "アラートを設定する": [
                            {
                                "対象を設定する": [
                                    "メトリクス",
                                    "ログ",
                                    "イベント",
                                ]
                            },
                            {"通知先を設定する": ["メール", "Slack", "Chat"]},
                            {
                                "アクションを設定する": [
                                    "自動スケーリング",
                                    "自動修復",
                                ]
                            },
                            {"条件を設定する": ["閾値", "期間"]},
                        ]
                    },
                    {"データベースアクセスを監視する": []},
                    {
                        "アクセスログを監視する": [
                            {"対象": ["API", "データベース", "ストレージ"]},  # 侵入検知
                        ]
                    },
                ]
            },
            {
                "Cloud KMSでデータの暗号化をする": [
                    {"方式を選択する": ["AES", "RSA", "ECC"]},
                    {"鍵の管理をする": ["鍵の生成", "鍵のローテーション"]},
                    {
                        "データの暗号化をする": [
                            "データの暗号化",
                            "データの復号化",
                        ]
                    },
                    {
                        "対象を選択する": [
                            "データベース/Cloud SQL",
                            "ファイル",
                            "通信",
                            "ストレージ",
                            "環境変数",
                        ]
                    },
                ]
            },
            {"ネットワークセキュリティをする": []},
            {"サービスアカウントを作成する": []},
            {"認証情報を取得する": []},
            {"ヘルスチェックを設定する": []},
            {"Let's Encryptで証明書を取得する": []},
            {
                "Google Cloud Container Registryにpushする": [
                    {
                        "pushするためのlocal dockerクライアントを設定する": [
                            "gcloudコマンドを使用してdockerクライアントを認証する",
                            "",
                        ]
                    },
                    {"イメージのタグ付けをする": []},
                    {"イメージの最適化をする": []},
                    {"イメージのバージョン管理をする": []},
                    {
                        "デプロイ環境の識別をする": [
                            "バージョン",
                            "環境：本番、ステージング、開発",
                            "リージョン",
                            "デプロイ日時",
                            "デプロイ方法",
                            "デプロイ者",
                        ]
                    },
                ]
            },
            {
                "Google Cloud Runにデプロイする": [
                    {
                        "サービスの設定をする": [
                            "インスタンス数",
                            "最大メモリ",
                            "環境変数",
                            "接続先の Cloud SQL",
                        ]
                    },
                    {
                        "デプロイオプションを設定する": [
                            "継続デプロイ",
                            "ロールバック",
                        ]
                    },
                    {
                        "デプロイ後の検証をする": [
                            "アプリケーションの動作確認",
                            "パフォーマンスの確認",
                        ]
                    },
                    {
                        "自動スケーリングを設定する": [
                            "リクエスト数に基づいてインスタンス数を自動調整",
                            "複数のコンテナを同時に実行",
                        ]
                    },
                    {
                        "コストを確認する": [
                            {"料金を確認する": []},
                            {"コストを削減する": []},
                        ]
                    },
                    {
                        "トラフィック管理をする": [
                            "ロードバランシング",
                            "レートリミット",
                            "キャッシュ",
                        ]
                    },
                    {"ルーティングを設定する": []},
                ]
            },
        ]
    },
    {
        "メンテナンス": [
            {
                "リソースの監視をする": [
                    {
                        "コストを監視する": [
                            "VPC",
                        ]
                    },
                ]
            },
            {"アプリケーションアップデートをする": []},
            {"せキュリティパッチを適用する": []},
            {"依存関係の管理をする": []},
            {"セキュリティスキャンをする": []},
            {"バックアップを取る": []},
        ]
    },
]
